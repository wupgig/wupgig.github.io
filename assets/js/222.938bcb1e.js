(window.webpackJsonp=window.webpackJsonp||[]).push([[222],{589:function(_,s,v){"use strict";v.r(s);var t=v(47),e=Object(t.a)({},(function(){var _=this,s=_.$createElement,v=_._self._c||s;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"redis-实现分布式锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#redis-实现分布式锁"}},[_._v("#")]),_._v(" Redis 实现分布式锁")]),_._v(" "),v("h2",{attrs:{id:"_0-分布式锁使用场景"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_0-分布式锁使用场景"}},[_._v("#")]),_._v(" 0. 分布式锁使用场景")]),_._v(" "),v("p",[_._v("一般我们使用分布式锁有两个场景：")]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("效率")]),_._v("：使用分布式锁可以避免不同节点重复相同的工作，这些工作会浪费资源。比如用户付了钱之后有可能不同节点会发出多封短信。")])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("正确性")]),_._v("：加分布式锁同样可以避免破坏正确性的发生，如果两个节点在同一条数据上面操作，比如多个节点机器对同一个订单操作不同的流程有可能会导致该笔订单最后状态出现错误，造成损失。")])])]),_._v(" "),v("p",[_._v("Redis 因为其性能好，实现起来分布式锁简单，所以让很多人都对基于 Redis 实现的分布式锁十分青睐。")]),_._v(" "),v("h2",{attrs:{id:"_1-实现原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-实现原理"}},[_._v("#")]),_._v(" 1. 实现原理")]),_._v(" "),v("p",[_._v("Redis 实现『"),v("strong",[_._v("分布式锁")]),_._v("』功能的原子操作主要是 "),v("strong",[_._v("SET")]),_._v(" 和 "),v("strong",[_._v("EXPIRE")]),_._v(" 操作，从 Redis 的 2.6.x 版本开始，其提供的 SET 命令格式如下：")]),_._v(" "),v("div",{staticClass:"language-shell extra-class"},[v("pre",{pre:!0,attrs:{class:"language-shell"}},[v("code",[_._v("SET "),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("key"),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v("<")]),_._v("value"),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v(">")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("[")]),_._v("EX seconds"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("]")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("[")]),_._v("PX milliseconds"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("]")]),_._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("[")]),_._v("NX "),v("span",{pre:!0,attrs:{class:"token operator"}},[_._v("|")]),_._v(" XX"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("]")]),_._v("\n")])])]),v("p",[v("strong",[_._v("EX")]),_._v(" 值的是 "),v("code",[_._v("key")]),_._v(" 的存活时间，单位为秒。"),v("strong",[_._v("PX")]),_._v(" 与 "),v("strong",[_._v("EX")]),_._v(" 作用一样，唯一的不同就是后者的单位是微秒"),v("small",[_._v("（使用较少）")]),_._v("。")]),_._v(" "),v("p",[v("strong",[_._v("NX")]),_._v(" 和 "),v("strong",[_._v("XX")]),_._v(" 作用是相反的。"),v("strong",[_._v("NX")]),_._v(" 表示只有当 key『"),v("strong",[_._v("不存在时")]),_._v("』才会设置其值；"),v("strong",[_._v("XX")]),_._v(" 表示当 "),v("code",[_._v("key")]),_._v(" 存在时才设置 "),v("code",[_._v("key")]),_._v(" 的值。")]),_._v(" "),v("p",[_._v("对于使用 "),v("code",[_._v("NX")]),_._v(" 选项的 "),v("code",[_._v("SET")]),_._v(" 命令，Redis 提供了一个别名命令："),v("code",[_._v("SETNX")]),_._v(" 。")]),_._v(" "),v("p",[_._v("在使用 "),v("code",[_._v("SETNX")]),_._v(" 操作实现分布式锁功能时，需要注意以下几点：")]),_._v(" "),v("ul",[v("li",[v("p",[_._v("这里的『锁』指的是 Redis 中的一个认为约定的键值对。谁能创建这个键值对，就意味着谁拥有这整个『锁』。")])]),_._v(" "),v("li",[v("p",[_._v("使用 "),v("code",[_._v("SETNX")]),_._v(" 命令获取『锁』时，如果操作返回结果是 0"),v("small",[_._v("（表示 key 已存在，设值失败）")]),_._v("，则意味着获取『锁』失败"),v("small",[_._v("（该锁被其它线程先获取）")]),_._v("，反之，则设值成功，表示获取『锁』成功。")]),_._v(" "),v("ul",[v("li",[v("p",[_._v("如果这个 "),v("strong",[_._v("key")]),_._v(" 不存在，SETNX 才会设置该 key 的值。此时 Redis 返回 1 。")])]),_._v(" "),v("li",[v("p",[_._v("如果这个 "),v("strong",[_._v("key")]),_._v(" 存在，SETNX 则不会设置该 key 的值。此时 Redis 返回 0 。")])])])]),_._v(" "),v("li",[v("p",[_._v("为了防止其它线程获得『锁』之后，有意或无意，长期持有『锁』而不释放"),v("small",[_._v("（导致其它线程无法获得该『锁』）")]),_._v("。因此，需要为 key 设置一个合理的过期时间。")])]),_._v(" "),v("li",[v("p",[_._v("当成功获得『锁』并成功完成响应操作之后，需要释放『锁』"),v("small",[_._v("（可以执行 DEL 命令将『锁』删除）")]),_._v("。")])])]),_._v(" "),v("p",[_._v("在代码层面，与 Setnx 命令对应的接口是 ValueOperations 的 "),v("strong",[_._v("setIfAbsent")]),_._v(" 方法。")]),_._v(" "),v("h2",{attrs:{id:"_2-工具类"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-工具类"}},[_._v("#")]),_._v(" 2. 工具类")]),_._v(" "),v("p",[_._v("见其它笔记。")])])}),[],!1,null,null,null);s.default=e.exports}}]);