(window.webpackJsonp=window.webpackJsonp||[]).push([[303],{671:function(t,s,a){"use strict";a.r(s);var n=a(47),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"open-session-in-view"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#open-session-in-view"}},[t._v("#")]),t._v(" open session in view")]),t._v(" "),a("p",[a("strong",[t._v("因为延迟加载")]),t._v("，你有可能在执行代码时，发现报如下错误。")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("LazyInitializationException")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" could not initialize proxy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("softeem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bean"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("po"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("Employee")]),t._v("#"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" no "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Session")]),t._v("\n\tat "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("AbstractLazyInitializer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbstractLazyInitializer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("169")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("core"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jar"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\tat "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("AbstractLazyInitializer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getImplementation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AbstractLazyInitializer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("309")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("core"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jar"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\tat "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pojo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bytebuddy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("ByteBuddyInterceptor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("intercept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ByteBuddyInterceptor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("45")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("core"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jar"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\tat "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),t._v("ProxyConfiguration")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterceptorDispatcher")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("intercept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProxyConfiguration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("95")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hibernate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("core"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jar"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.3")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Final"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("例如，去查询一个员工信息，在 Service 层向 Web 层返回 Employee 对象后，去打印员工的部门的名字。")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("不过，在 Spring Boot 中看到这个问题并不是很容易，因为，Spring Boot 的默认配置启用了 opne-session-in-view 功能，解决了这个问题。因此，你需要将这个功能关掉，才能看到这个错。")]),t._v(" "),a("p",[t._v("关闭的方法是：在配置文件中添加配置："),a("code",[t._v("spring.jpa.open-in-view=false")]),t._v(" 。很显然，这个配置项的默认值是 "),a("strong",[t._v("true")]),t._v(" 。")])]),t._v(" "),a("p",[t._v("出现这个问题的原因在于，当 Service 层的方法执行结束返回 Employee 对象时，与数据库之间的连接已经断开。因为延迟加载的原因，当 Web 层因为 "),a("code",[t._v(".getDepartment()")]),t._v(" 而导致需要查询 Department 时，自然就没有连接/会话来支持这个操作的执行。")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("从 Hibernate 的角度解释是，Employee 对象已经从持久态变为游离态，此时，无法再通过 Employee 对象去查询相关的 Department 对象了。")])]),t._v(" "),a("p",[t._v("open-session-in-view 功能本质上就是延迟 session 的关闭，将原本在 Service 层结束时就该关闭的 Session，推迟到 Web 层结束时再关闭。因此，在 Web 层的方法中，你触发延迟加载时，仍有 session 可用，以支持背后的自动的查询行为。")]),t._v(" "),a("p",[t._v("启用 open-session-in-view 功能需要进行两步配置。不过这里 Spring Boot 都『帮』我们干完了。")]),t._v(" "),a("p",[t._v("启动类"),a("small",[t._v("（或某个配置类）")]),t._v("中加入")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OpenEntityManagerInViewFilter")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("openEntityManagerInViewFilter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OpenEntityManagerInViewFilter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("配置文件中加入 "),a("code",[t._v("spring.jpa.open-in-view=true")]),t._v(" 。")])])}),[],!1,null,null,null);s.default=e.exports}}]);