(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{507:function(t,e,a){"use strict";a.r(e);var _=a(47),v=Object(_.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[t._v("#")]),t._v(" 事务")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("『"),a("strong",[t._v("事务")]),t._v("』本身是数据库领域中的概念，而非编程语言"),a("small",[t._v("（如 Java）")]),t._v("中的概念！是因为我们要在代码中去操作数据库，因此，我们的代码中『才会涉及』、『才有了事务』的概念。不要搞错了因果关系！")])]),t._v(" "),a("h2",{attrs:{id:"事务的-acid-属性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事务的-acid-属性"}},[t._v("#")]),t._v(" 事务的 ACID 属性")]),t._v(" "),a("p",[t._v("数据库事务的正确执行的 4 个基本要素是 原子性"),a("small",[t._v("（"),a("strong",[t._v("A")]),t._v("tommicity）")]),t._v("、一致性"),a("small",[t._v("（"),a("strong",[t._v("C")]),t._v("onsistency）")]),t._v("、隔离性"),a("small",[t._v("（"),a("strong",[t._v("I")]),t._v("solation）")]),t._v("和 持久性"),a("small",[t._v("（"),a("strong",[t._v("D")]),t._v("urability）")]),t._v("。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("问题")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("原子性            ")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("整个事务中的操作，要么全部完成，要么全部不完成，不可能停滞在中间某个环节，仅完成一部分。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("一致性")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务必须使数据库从一个一致状态变为另一个一致状态。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("隔离性")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("事务的隔离性是指一个事务的执行过程中不被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的事务之间不能互相干扰。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("持久性")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("在事务完成以后，该事务对数据库所做的更改便持久保存在数据库中，并不会被回滚。")])])])]),t._v(" "),a("h2",{attrs:{id:"三大问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三大问题"}},[t._v("#")]),t._v(" 三大问题")]),t._v(" "),a("p",[t._v("三大问题从 严重 到 轻度 以此如下：")]),t._v(" "),a("h3",{attrs:{id:"脏读问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#脏读问题"}},[t._v("#")]),t._v(" 脏读问题")]),t._v(" "),a("p",[t._v("对于两个事务 T1 和 T2 可能会出现如下情况，T1 读取了已经被 T2 "),a("strong",[t._v("更新但是还未提交")]),t._v(" 的字段，若此时 T2 回滚，那么 T1 读取到的内容就是临时且无效的。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("时刻")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务一（老公）")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务二（老婆）")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询余额，显示 10k")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询余额，显示 10k")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T3")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("网购 1千，显示 9k")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T4")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("请客吃饭开销 1k，显示余额 8k")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T5")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("提交事务")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T6")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("回滚事务")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T7")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("最终余额 8k")])])])]),t._v(" "),a("p",[t._v("所谓脏读，指的就是读到了“脏”数据，即一个事务读取到了另一个事务未提交的数据。")]),t._v(" "),a("h3",{attrs:{id:"不可重复读问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不可重复读问题"}},[t._v("#")]),t._v(" 不可重复读问题")]),t._v(" "),a("p",[t._v("对于两个事务 T1 和 T2 可能会出现如下情况，T1 读取了一个字段，然后 T2 更新了这个字段。之后，T1 再次读取该字段时，会发现值发生了变化。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("时刻")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务一（老公）")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务二（老婆）")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询余额，显示10k")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询余额，显示 10k")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T3")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("网购，开销 1k，余额 9k")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T4")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("请客吃饭，预计开销 2k")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T5")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("网购，开销 8k，余额 1k")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T6")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("提交事务")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T7")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("吃完买单，显示余额 1k，不够付账。")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])])])]),t._v(" "),a("p",[t._v("不可重复读，指的是理论上的同一条数据，重复读取，居然会不一样，不具备可重复性。")]),t._v(" "),a("h3",{attrs:{id:"幻读问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#幻读问题"}},[t._v("#")]),t._v(" 幻读问题")]),t._v(" "),a("p",[t._v("对于两个事务 T1 和 T2 可能会出现如下情况，T1 从一个表中读取了一个字段，然后 T2 在该表中插入了一些新的数据。之后，T1 再次读取该字段时，会发现多出来几行。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("时刻")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务一（老公）")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("事务二（老婆）")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询信用卡消费记录，显示 10 条记录")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("网购")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T3")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("提交事务")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("T4")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("——")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("打印消费记录，有11条记录")])])])]),t._v(" "),a("p",[t._v("幻读，和不可重复读类似，第二次读取的数据相较于第一次居然发生了变化，仿佛看到了幻觉。")]),t._v(" "),a("p",[t._v("『不可重复读』和『幻读』有一定的相似性，都是指"),a("small",[t._v("（在本人未改变的情况下）")]),t._v("第二次读取的数据，与第一次读取结果不一样。不过它们描述的侧重点（及造成的影响程度）不一样。")]),t._v(" "),a("ul",[a("li",[t._v("不可重复读问题，强调的是某一条数据的内容在“我”两次读取间，发生了改变。"),a("small",[t._v("（因为 update 语句）")])]),t._v(" "),a("li",[t._v("幻读问题，强调的整个数据的数据总量，在“我”两次读取间，发生了改变。"),a("small",[t._v("（因为 insert / delete 语句）")])]),t._v(" "),a("li",[t._v("幻读问题 造成的危害要小于不可重复读问题。")])]),t._v(" "),a("p",[a("strong",[t._v("不可重复读")]),t._v(" 和 "),a("strong",[t._v("幻读")]),t._v(" 在一定程度上是可接受的，而 "),a("strong",[t._v("脏读")]),t._v(" 是完全不可接受的。")]),t._v(" "),a("h2",{attrs:{id:"四个隔离级别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四个隔离级别"}},[t._v("#")]),t._v(" 四个隔离级别")]),t._v(" "),a("p",[t._v("隔离级别表示："),a("strong",[t._v("当『我』操作这张表时，『其他人』对这张表还有多大的操作权限")]),t._v(" 。『我』的隔离级别越高，其他人的权利就越小，那么『他』要执行他想要执行的操作而没有权限时，那就只能 "),a("strong",[t._v("等")]),t._v("『我』操作完 。")]),t._v(" "),a("p",[t._v("数据库领域有四个隔离级别"),a("small",[t._v("（注意，这并非 Java 中特有的概念）")]),t._v("，针对于上述三大问题，四个隔离级别，从 "),a("em",[t._v("解决不了任何问题")]),t._v(" 到 "),a("em",[t._v("解决所有问题")]),t._v(" ，每一级多解决一个问题。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("隔离级别")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("解决问题")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("备注")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("READ_UNCOMMITTED")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("解决不了任何问题")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("READ_COMMITTED")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可以解决"),a("code",[t._v("脏读")]),t._v("问题")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("——")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("REPEATABLE_READ")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("可以解决"),a("code",[t._v("不可重复读")]),t._v("问题")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[a("small",[t._v("包括解决"),a("code",[t._v("脏读")]),t._v("问题")])])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("SERIALIZABLE")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("解决"),a("code",[t._v("幻读")]),t._v("问题")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[a("small",[t._v("包括解决"),a("code",[t._v("不可重复读")]),t._v("和"),a("code",[t._v("脏读")]),t._v("问题")])])])])]),t._v(" "),a("p",[t._v("隔离级别越高，事务间的相互干扰就越小，数据的一致性就越好，但同时并发性就越弱。")]),t._v(" "),a("p",[t._v("MySQL 支持四种隔离级别，默认事务隔离级别为 "),a("strong",[t._v("Repeatable Read")]),t._v(" 。")]),t._v(" "),a("h2",{attrs:{id:"jdbc-事务的自动提交和隔离级别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jdbc-事务的自动提交和隔离级别"}},[t._v("#")]),t._v(" JDBC 事务的自动提交和隔离级别")]),t._v(" "),a("p",[t._v("Connection 类中有如下实例方法：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置事务开启自动提交")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAutoCommit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" autoCommit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SQLException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置事务的隔离级别")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTransactionIsolation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" level"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SQLException")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TRANSACTION_NONE\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TRANSACTION_READ_UNCOMMITTED\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TRANSACTION_READ_COMMITTED\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TRANSACTION_REPEATABLE_READ\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TRANSACTION_SERIALIZABLE\n")])])])])}),[],!1,null,null,null);e.default=v.exports}}]);