(window.webpackJsonp=window.webpackJsonp||[]).push([[239],{608:function(t,e,a){"use strict";a.r(e);var l=a(47),v=Object(l.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"缓存与数据库一致性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存与数据库一致性"}},[t._v("#")]),t._v(" 缓存与数据库一致性")]),t._v(" "),a("h2",{attrs:{id:"cache-aside-pattern"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cache-aside-pattern"}},[t._v("#")]),t._v(" Cache Aside Pattern")]),t._v(" "),a("p",[t._v("标准的方案，facebook 就是使用这种方式。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("核心概念")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("失效")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("应用程序先从 cache 取数据，没有得到，则从数据库中取数据，成功后，放到缓存中。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("命中")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("应用程序从 cache 中取数据，取到后返回。")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("更新")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("先把数据存到数据库中，成功后，再让缓存失效。")])])])]),t._v(" "),a("h3",{attrs:{id:"读流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读流程"}},[t._v("#")]),t._v(" 读流程：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("步骤")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("读缓存，命中则直接返回")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("如果没命中，读数据库")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新缓存")])])])]),t._v(" "),a("h3",{attrs:{id:"写流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写流程"}},[t._v("#")]),t._v(" 写流程：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("步骤")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新数据库")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("删缓存，使缓存失效")])])])]),t._v(" "),a("h2",{attrs:{id:"双写并发问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#双写并发问题"}},[t._v("#")]),t._v(" 双写并发问题")]),t._v(" "),a("p",[t._v("Cache Aside Pattern 方案能解决 "),a("code",[t._v("双写并发")]),t._v(" 问题：")]),t._v(" "),a("blockquote",[a("p",[t._v("双写并发：简而言之，"),a("code",[t._v("张三的写操作")]),t._v(" 一旦和 "),a("code",[t._v("李四的写操作")]),t._v(" 交织在一起，就会导致缓存中的数据错误。")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("#")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("用户")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("操作")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("数据库中的值")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("缓存中的值")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("10 -> 20")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("20 -> 30")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("30")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("删除缓存")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("30")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("删除缓存")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("30")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("7")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("最终")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("-")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("30")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])])])]),t._v(" "),a("h2",{attrs:{id:"读写并发问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读写并发问题"}},[t._v("#")]),t._v(" 读写并发问题")]),t._v(" "),a("p",[t._v("Cache Aside Pattern 方案能解决不了全部的 "),a("code",[t._v("读写并发")]),t._v(" 问题：")]),t._v(" "),a("blockquote",[a("p",[t._v("读写并发：简而言之，"),a("code",[t._v("张三的写操作")]),t._v(" 一旦和 "),a("code",[t._v("李四的读操作")]),t._v(" 交织在一起，就会导致缓存中的数据错误。")])]),t._v(" "),a("p",[t._v("一部分的 "),a("code",[t._v("读写并发")]),t._v(" 问题，Cache Aside Pattern 方案能解决。例如：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("#")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("用户")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("操作")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("数据库中的值")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("缓存中的值")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("读缓存，没命中")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("10 -> 20")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("删除缓存")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("读数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("5")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新缓存，同步数据")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("6")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("最终")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("-")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")])])])]),t._v(" "),a("p",[t._v("但是，如果是下面这样的交织时序，Cache Aside Pattern 方案也无能为力：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("#")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("用户")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("操作")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("数据库中的值")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("缓存中的值")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-读-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("读缓存，没命中")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-读-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("读数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-写-1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新数据库")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("code",[t._v("10 -> 20")])]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("5")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("张三-写-2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("删除缓存")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("无")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("6")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("李四-读-3")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新缓存")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("7")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("最终")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("-")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("20")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("10")])])])]),t._v(" "),a("h2",{attrs:{id:"cache-aside-pattern-方案总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cache-aside-pattern-方案总结"}},[t._v("#")]),t._v(" Cache Aside Pattern 方案总结")]),t._v(" "),a("p",[t._v("这个方案足够简单，容易理解，容易实现。只是面对『"),a("strong",[t._v("部分读写并发问题无能为力")]),t._v("』，不过，实际上出现这种概率可能非常低，因为这个条件需要发生在读缓存时缓存失效，而且并发着有一个写操作。而实际上数据库的写操作会比读操作慢得多，而且还要锁表，而读操作必需在写操作前进入数据库操作，而又要晚于写操作更新缓存，所有的这些条件都具备的概率基本并不大。")]),t._v(" "),a("h2",{attrs:{id:"cache-aside-pattern-方案的改进"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cache-aside-pattern-方案的改进"}},[t._v("#")]),t._v(" Cache Aside Pattern 方案的改进")]),t._v(" "),a("h3",{attrs:{id:"方案-1-延迟删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案-1-延迟删除"}},[t._v("#")]),t._v(" 方案 1：延迟删除")]),t._v(" "),a("p",[t._v("将写操作的『删除 Redis』操作改为异步的延迟删除。例如：更新完数据库，1 秒钟之后再删除缓存。")]),t._v(" "),a("p",[t._v("这种情况下，读写并发造成的数据不一致问题最多也就存在 1 秒。")]),t._v(" "),a("blockquote",[a("p",[t._v("这个改进方案的问题在于：你要延迟多久？延迟的时间短了没有解决读写并发问题；延迟的时间越长不一致隐患就越大。")]),t._v(" "),a("p",[t._v("当然，在一致性要求不是那么高的情况下，有 3、5 秒的窗口期数据不一致很正常。")])]),t._v(" "),a("h3",{attrs:{id:"方案-2-借助消息队列-将删存缓存的工作委托给第三方"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方案-2-借助消息队列-将删存缓存的工作委托给第三方"}},[t._v("#")]),t._v(" 方案 2：借助消息队列，将删存缓存的工作委托给第三方")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("读数据的人，在发现缓存中没有数据时，不再由他自己来刷新缓存，而是由『别人』来刷新；")])]),t._v(" "),a("li",[a("p",[t._v("写数据的人，在更新完数据库之后，不再由他自己来删除缓存，而是由『别人』来删除；")])])]),t._v(" "),a("p",[t._v("简单来说：『别人』先查后刷，查刷一体 。")]),t._v(" "),a("p",[t._v("分析：『别人』是串行化接收、处理消息，在更新缓存时，他是先读 DB，再写 Cache ，这个过程中是没有『其它的别人』插入的。")])])}),[],!1,null,null,null);e.default=v.exports}}]);